<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aè‚¡é€‰è‚¡å·¥å…·</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 10px;
    }
    header h1 { font-size: 2rem; margin-bottom: 10px; }
    header p { opacity: 0.9; }
    .run-info { font-size: 0.9rem; margin-top: 15px; opacity: 0.8; }
    
    /* Tab å¯¼èˆª */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .tab:hover {
      color: #333;
      background: #f5f5f5;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    /* Tab å†…å®¹ */
    .tab-content {
      display: none;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .tab-content.active {
      display: block;
    }

    .content-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-bottom: 1px solid #e0e0e0;
    }
    .content-header h2 {
      font-size: 1.3rem;
      color: #333;
      margin-bottom: 8px;
    }
    .content-header .description {
      color: #666;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .content-header .count-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-left: 10px;
    }
    
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th {
      background: #fafafa;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    th:hover { background: #f0f0f0; }
    th .sort-icon { margin-left: 5px; opacity: 0.5; }
    th.sorted .sort-icon { opacity: 1; }
    
    tr:hover { background: #f9f9f9; }
    
    .stock-link {
      color: #1976d2;
      text-decoration: none;
      font-weight: 500;
    }
    .stock-link:hover { text-decoration: underline; }
    
    .value { font-family: "SF Mono", Monaco, Consolas, monospace; }
    .value.positive { color: #c62828; }
    .value.negative { color: #2e7d32; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .error {
      text-align: center;
      padding: 40px;
      color: #c62828;
    }
    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .history-section {
      margin-top: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .history-section h3 {
      margin-bottom: 15px;
      color: #666;
      font-size: 1.2rem;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #5b7fff;
    }
    .history-item:hover {
      background: #e9ecef;
    }
    .history-date {
      font-weight: 600;
      color: #333;
      font-size: 1.1rem;
    }
    .history-stats {
      display: flex;
      gap: 20px;
      color: #666;
      font-size: 0.9rem;
    }
    .history-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .history-stat .label {
      color: #999;
    }
    .history-stat .value {
      font-weight: 600;
      color: #333;
    }
    .history-stat .value.success {
      color: #28a745;
    }
    .history-item {
      cursor: pointer;
      transition: all 0.2s;
    }
    .history-details {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      display: none;
    }
    .history-details.show {
      display: block;
    }
    .history-details table {
      width: 100%;
      font-size: 0.9rem;
    }
    .history-details th {
      background: #f8f9fa;
      padding: 8px;
      text-align: left;
      font-weight: 600;
    }
    .history-details td {
      padding: 6px 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    footer {
      text-align: center;
      padding: 30px;
      color: #999;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“ˆ Aè‚¡é€‰è‚¡å·¥å…·</h1>
      <p>åŸºäºæŠ€æœ¯æŒ‡æ ‡çš„æ™ºèƒ½é€‰è‚¡ç³»ç»Ÿ</p>
      <div class="run-info" id="runInfo">åŠ è½½ä¸­...</div>
    </header>

    <!-- Tab å¯¼èˆª -->
    <div class="tabs" id="tabsContainer">
      <div class="loading">åŠ è½½ç»„åˆä¸­...</div>
    </div>

    <!-- Tab å†…å®¹å®¹å™¨ -->
    <div id="tabContentsContainer"></div>

    <!-- å†å²è®°å½•åŒºåŸŸ -->
    <div class="history-section">
      <h3>ğŸ“… è¿è¡Œå†å²</h3>
      <div id="historyContainer">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <footer>
      æ•°æ®æ¥æºï¼šBaoStock | æ›´æ–°æ—¶é—´ï¼šæ¯äº¤æ˜“æ—¥ 16:30
    </footer>
  </div>
  
  <script>
    // é…ç½®
    const API_BASE = window.location.hostname === 'localhost' || window.location.protocol === 'file:'
      ? 'http://localhost:8787'
      : 'https://ashare.aigc.it';  // ç”Ÿäº§ç¯å¢ƒ Worker URL

    // å› å­åˆ—åæ˜ å°„
    const FACTOR_LABELS = {
      ma60_change_pct: 'MA60å˜åŒ–%',
      ma20_change_pct: 'MA20å˜åŒ–%',
      ma_distance: 'MAè·ç¦»%',
      macd_days_ago: 'MACDé‡‘å‰',
      rsi: 'RSI',
      turnover_avg: 'æ¢æ‰‹ç‡%',
      n_day_return: 'Næ—¥æ¶¨å¹…%',
    };

    // å…¨å±€çŠ¶æ€
    let combinations = [];
    let combinationData = {};  // { combinationId: { data: [], sortKey: null, sortAsc: true } }
    let activeTab = null;

    // è·å–ç»„åˆåˆ—è¡¨
    async function fetchCombinations() {
      const res = await fetch(`${API_BASE}/api/combinations`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json.combinations || [];
    }

    // è·å–ç­›é€‰æ•°æ®
    async function fetchData(combination) {
      const res = await fetch(`${API_BASE}/api/screening/latest?combination=${combination}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json.data || [];
    }

    // è·å–å†å²è®°å½•
    async function fetchHistory() {
      const res = await fetch(`${API_BASE}/api/screening/history`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json.data || [];
    }

    // è·å–æŒ‡å®šæ—¥æœŸçš„ç­›é€‰ç»“æœ
    async function fetchDataByDate(date, combination) {
      const url = `${API_BASE}/api/screening/by-date?date=${date}${combination ? '&combination=' + combination : ''}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      return json.data || [];
    }

    // æ„å»ºä¸œæ–¹è´¢å¯Œé“¾æ¥
    function buildEMLink(code) {
      // code æ ¼å¼: sh.600001 æˆ– sz.000001
      const [market, num] = code.split('.');
      const secid = market === 'sh' ? `1.${num}` : `0.${num}`;
      return `https://quote.eastmoney.com/${market}${num}.html`;
    }

    // æ ¼å¼åŒ–æ•°å€¼
    function formatValue(val) {
      if (val === null || val === undefined) return '-';
      const num = parseFloat(val);
      if (isNaN(num)) return val;
      return num.toFixed(2);
    }

    // æ¸²æŸ“ Tab å¯¼èˆª
    function renderTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = combinations.map((combo, idx) => `
        <button class="tab ${idx === 0 ? 'active' : ''}" data-id="${combo.id}">
          ${combo.label}
        </button>
      `).join('');

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      container.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => switchTab(tab.dataset.id);
      });
    }

    // æ¸²æŸ“ Tab å†…å®¹
    function renderTabContents() {
      const container = document.getElementById('tabContentsContainer');
      container.innerHTML = combinations.map((combo, idx) => `
        <div class="tab-content ${idx === 0 ? 'active' : ''}" id="content-${combo.id}">
          <div class="content-header">
            <h2>
              ${combo.label}
              <span class="count-badge" id="count-${combo.id}">-</span>
            </h2>
            <p class="description">${combo.description}</p>
          </div>
          <div class="table-container">
            <div class="loading" id="loading-${combo.id}">åŠ è½½ä¸­...</div>
            <table id="table-${combo.id}" style="display:none;">
              <thead id="thead-${combo.id}"></thead>
              <tbody id="tbody-${combo.id}"></tbody>
            </table>
          </div>
        </div>
      `).join('');
    }

    // åˆ‡æ¢ Tab
    function switchTab(combinationId) {
      activeTab = combinationId;

      // æ›´æ–° Tab æ ·å¼
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.id === combinationId);
      });

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `content-${combinationId}`);
      });
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(combinationId) {
      const state = combinationData[combinationId];
      if (!state) return;

      const { data, sortKey, sortAsc } = state;
      const table = document.getElementById(`table-${combinationId}`);
      const thead = document.getElementById(`thead-${combinationId}`);
      const tbody = document.getElementById(`tbody-${combinationId}`);
      const loading = document.getElementById(`loading-${combinationId}`);

      if (data.length === 0) {
        table.style.display = 'none';
        loading.className = 'empty';
        loading.textContent = 'æš‚æ— æ•°æ®';
        loading.style.display = 'block';
        return;
      }

      loading.style.display = 'none';
      table.style.display = 'table';

      // æ’åº
      let sorted = [...data];
      if (sortKey) {
        sorted.sort((a, b) => {
          const va = parseFloat(a[sortKey]) || 0;
          const vb = parseFloat(b[sortKey]) || 0;
          return sortAsc ? va - vb : vb - va;
        });
      }

      // è¡¨å¤´
      const factorKeys = Object.keys(FACTOR_LABELS).filter(k =>
        data.some(d => d[k] !== null && d[k] !== undefined)
      );

      thead.innerHTML = `<tr>
        <th>ä»£ç </th>
        <th>åç§°</th>
        <th data-sort="latest_price">ä»·æ ¼ <span class="sort-icon">â†•</span></th>
        ${factorKeys.map(k => `<th data-sort="${k}" class="${sortKey === k ? 'sorted' : ''}">${FACTOR_LABELS[k]} <span class="sort-icon">${sortKey === k ? (sortAsc ? 'â†‘' : 'â†“') : 'â†•'}</span></th>`).join('')}
      </tr>`;

      // ç»‘å®šæ’åºäº‹ä»¶
      thead.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
          const key = th.dataset.sort;
          if (state.sortKey === key) {
            state.sortAsc = !state.sortAsc;
          } else {
            state.sortKey = key;
            state.sortAsc = false;
          }
          renderTable(combinationId);
        };
      });

      // è¡¨ä½“
      tbody.innerHTML = sorted.map(row => `<tr>
        <td><a class="stock-link" href="${buildEMLink(row.code)}" target="_blank">${row.code}</a></td>
        <td>${row.name || '-'}</td>
        <td class="value">${formatValue(row.latest_price)}</td>
        ${factorKeys.map(k => {
          const val = row[k];
          const cls = val > 0 ? 'positive' : val < 0 ? 'negative' : '';
          return `<td class="value ${cls}">${formatValue(val)}</td>`;
        }).join('')}
      </tr>`).join('');
    }

    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory(historyData) {
      const container = document.getElementById('historyContainer');

      if (historyData.length === 0) {
        container.innerHTML = '<div class="empty">æš‚æ— è¿è¡Œè®°å½•</div>';
        return;
      }

      container.innerHTML = `
        <div class="history-list">
          ${historyData.map((log, idx) => {
            const date = new Date(log.run_date);
            const dateStr = date.toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              weekday: 'short'
            });
            const timeStr = log.created_at ? new Date(log.created_at).toLocaleTimeString('zh-CN', {
              hour: '2-digit',
              minute: '2-digit'
            }) : '';

            return `
              <div>
                <div class="history-item" data-date="${log.run_date}" data-index="${idx}">
                  <div class="history-date">${dateStr} ${timeStr}</div>
                  <div class="history-stats">
                    <div class="history-stat">
                      <span class="label">æ€»æ•°:</span>
                      <span class="value">${log.total_stocks || 0}</span>
                    </div>
                    <div class="history-stat">
                      <span class="label">é€šè¿‡:</span>
                      <span class="value success">${log.passed_stocks || 0}</span>
                    </div>
                    <div class="history-stat">
                      <span class="label">è€—æ—¶:</span>
                      <span class="value">${log.duration_seconds ? log.duration_seconds.toFixed(1) + 's' : '-'}</span>
                    </div>
                    <div class="history-stat">
                      <span class="label">çŠ¶æ€:</span>
                      <span class="value ${log.status === 'success' ? 'success' : ''}">${log.status || '-'}</span>
                    </div>
                  </div>
                </div>
                <div class="history-details" id="details-${idx}">
                  <div class="loading">åŠ è½½ä¸­...</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      container.querySelectorAll('.history-item').forEach(item => {
        item.onclick = () => toggleHistoryDetails(item.dataset.date, item.dataset.index);
      });
    }

    // åˆ‡æ¢å†å²è®°å½•è¯¦æƒ…
    async function toggleHistoryDetails(date, index) {
      const detailsEl = document.getElementById(`details-${index}`);

      // å¦‚æœå·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
      if (detailsEl.classList.contains('show')) {
        detailsEl.classList.remove('show');
        return;
      }

      // å±•å¼€å¹¶åŠ è½½æ•°æ®
      detailsEl.classList.add('show');
      detailsEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const data = await fetchDataByDate(date);

        if (data.length === 0) {
          detailsEl.innerHTML = '<div class="empty">è¯¥æ—¥æœŸæ— ç­›é€‰ç»“æœ</div>';
          return;
        }

        // æŒ‰ç»„åˆåˆ†ç»„
        const grouped = {};
        data.forEach(row => {
          const combo = row.combination || 'unknown';
          if (!grouped[combo]) grouped[combo] = [];
          grouped[combo].push(row);
        });

        // æ¸²æŸ“è¡¨æ ¼
        detailsEl.innerHTML = Object.entries(grouped).map(([comboId, rows]) => {
          const combo = combinations.find(c => c.id === comboId);
          const comboLabel = combo ? combo.label : comboId;

          return `
            <h4 style="margin: 10px 0 5px 0; color: #666;">${comboLabel} (${rows.length})</h4>
            <table>
              <thead>
                <tr>
                  <th>ä»£ç </th>
                  <th>åç§°</th>
                  <th>ä»·æ ¼</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr>
                    <td><a class="stock-link" href="${buildEMLink(row.code)}" target="_blank">${row.code}</a></td>
                    <td>${row.name || '-'}</td>
                    <td>${formatValue(row.latest_price)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }).join('');
      } catch (err) {
        console.error('åŠ è½½å†å²è¯¦æƒ…å¤±è´¥:', err);
        detailsEl.innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
      }
    }

    // åŠ è½½å†å²è®°å½•
    async function loadHistory() {
      try {
        const data = await fetchHistory();
        renderHistory(data);
      } catch (err) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', err);
        document.getElementById('historyContainer').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
      }
    }

    // åŠ è½½å•ä¸ªç»„åˆçš„æ•°æ®
    async function loadCombinationData(combinationId) {
      const loading = document.getElementById(`loading-${combinationId}`);
      const countEl = document.getElementById(`count-${combinationId}`);

      try {
        const data = await fetchData(combinationId);
        combinationData[combinationId] = {
          data,
          sortKey: null,
          sortAsc: true,
        };
        countEl.textContent = data.length;
        renderTable(combinationId);
      } catch (err) {
        loading.className = 'error';
        loading.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
        loading.style.display = 'block';
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      try {
        // 1. åŠ è½½ç»„åˆåˆ—è¡¨
        combinations = await fetchCombinations();

        if (combinations.length === 0) {
          document.getElementById('tabsContainer').innerHTML = '<div class="error">æœªæ‰¾åˆ°ä»»ä½•ç»„åˆ</div>';
          return;
        }

        // 2. æ¸²æŸ“ Tab å¯¼èˆªå’Œå†…å®¹å®¹å™¨
        renderTabs();
        renderTabContents();

        // 3. è®¾ç½®ç¬¬ä¸€ä¸ª Tab ä¸ºæ¿€æ´»çŠ¶æ€
        activeTab = combinations[0].id;

        // 4. åŠ è½½æ‰€æœ‰ç»„åˆçš„æ•°æ®
        await Promise.all(combinations.map(combo => loadCombinationData(combo.id)));

        // 5. åŠ è½½å†å²è®°å½•
        loadHistory(); // å¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡ä¸»æµç¨‹

        // 6. æ›´æ–°è¿è¡Œä¿¡æ¯
        const firstData = Object.values(combinationData)[0]?.data[0];
        if (firstData?.run_date) {
          document.getElementById('runInfo').textContent = `æœ€æ–°æ•°æ®ï¼š${firstData.run_date}`;
        } else {
          document.getElementById('runInfo').textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
        }
      } catch (err) {
        document.getElementById('tabsContainer').innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${err.message}</div>`;
      }
    }

    init();
  </script>
</body>
</html>

