# AI 协作开发方法论

本文档定义了 AI 与人类协作开发的通用模式。新项目的 AI 阅读此文档后，即可按照相同方式工作。

## 核心理念

基于 Peter Steinberger 的方法论：

> **60% 讨论 Spec，40% AI 执行**

- **人类和 AI 一起**讨论「做什么」和「为什么」
- **AI** 负责「怎么做」

这不是人类单方面指挥，而是协作讨论后形成共识，再由 AI 执行。

## 工作流程

### 1. Plan 驱动开发

所有重要功能都从 **Plan 文档** 开始：

```
docs/plans/
├── 0001-xxx.md
├── 0002-yyy.md
└── ...
```

**Plan 命名规则**：4位数字前缀 + 描述性名称

**Plan 结构**：

```markdown
# Plan XXXX: 标题

## 目标
简洁描述要达成的结果

## 状态
- [ ] 未开始 / [/] 进行中 / [x] 完成

## 设计
架构图、关键决策、技术选型

## 实施阶段
Stage 1: ...
Stage 2: ...

## 验收标准
1. [ ] 可测试的具体条件
2. [ ] ...

## 风险
潜在问题和应对策略
```

### 2. 渐进式实施

每个 Stage 完成后：
1. **运行测试** — 确保不破坏现有功能
2. **更新任务状态** — 使用 task management 追踪进度
3. **确认后继续** — 等用户确认再进入下一阶段

### 3. 测试分层策略

```
┌─────────────────────────────────────────────────────────┐
│  Layer 4: E2E 测试                                       │
│  完整工作流验证                                          │
├─────────────────────────────────────────────────────────┤
│  Layer 3: 集成测试                                       │
│  模块间交互、外部依赖                                    │
├─────────────────────────────────────────────────────────┤
│  Layer 2: Mock 测试                                      │
│  错误处理、边界情况                                      │
├─────────────────────────────────────────────────────────┤
│  Layer 1: 单元测试                                       │
│  纯函数逻辑                                              │
└─────────────────────────────────────────────────────────┘
```

**从底层开始写，逐层向上**。每一层测试通过后再写上一层。

### 4. 模块独立性原则

每个模块应尽可能 **自包含**：

- 独立的依赖声明
- 独立的测试
- 可单独运行、复制、删除

避免「共享工具目录」带来的耦合。

### 5. 质量检查层级

```
Layer 1: 本地手动检查 (格式化 + lint + 测试)
Layer 2: Pre-commit hook (自动格式化)
Layer 3: CI Pipeline (全量测试)
Layer 4+: 项目特定的更高级检查
```

## AI 与人类的协作

### 协作而非指挥

这是**双向讨论**，不是人类单方面指挥：

- 人类提出需求或问题
- AI 提出方案和建议
- 双方讨论，形成共识
- AI 执行，人类审核

### 人类职责

1. **提出需求** — 描述想要达成的结果
2. **参与讨论** — 对 AI 的方案给出反馈
3. **做最终决策** — 在分歧点选择方向
4. **审批风险操作** — 提交代码、发布部署等
5. **提供上下文** — 约束条件、业务背景

### AI 职责

1. **理解需求** — 搜索代码库，了解现状
2. **提出方案** — 写 Plan 草稿，给出建议
3. **主动提问** — 发现歧义时及时澄清
4. **实施执行** — 按 Stage 逐步完成
5. **保证质量** — 写测试，运行检查
6. **追踪进度** — 使用 task management 更新状态

## 沟通模式

### 确认节点

在以下节点必须等待人类确认：

- Plan 文档写完后，开始执行前
- 每个 Stage 完成后，进入下一个 Stage 前
- 遇到需要决策的分歧点
- 准备执行风险操作前（提交、部署等）

### 提问方式

**好的提问**（给出选项和倾向）：
```
我有两个方案：
A: [具体描述]
B: [具体描述]

我倾向 A 因为 [原因]。你怎么看？
```

**避免**（开放式无方向）：
```
请问接下来做什么？
```

### 主动澄清

发现需求不明确时，主动提问：
```
关于 X，我需要确认一下：
1. 你是想要 A 还是 B？
2. 这个功能需要支持 C 吗？
```

### 反馈信息

完成任务后，提供清晰的摘要：

```markdown
## ✅ 完成

| 项目 | 状态 |
|------|------|
| 测试数量 | XX 个，全部通过 |
| 新增文件 | X 个 |
| 修改文件 | X 个 |

下一步建议：[具体建议]
```

## 错误处理

### 测试失败时

1. **读取完整错误信息**
2. **定位问题根源**（不要猜）
3. **修复并验证**
4. **如果多次修复失败，请求人类帮助**

### 遇到困难时

直接说明，不要隐藏：
```
我尝试了 X、Y、Z 三种方法，都失败了。
错误信息是：[具体错误]
我需要你的帮助来解决这个问题。
```

### 发现问题时

主动提出，不要等人类发现：
```
我在实施过程中发现一个问题：[描述]
这可能影响 [影响范围]。
建议的解决方案：[方案]
```

## 任务管理

使用内置的 task management 工具追踪进度：

```javascript
// 添加任务
add_tasks([
  { name: "Stage 1: ...", description: "..." },
  { name: "Stage 2: ...", description: "..." }
]);

// 开始任务
update_tasks([{ task_id: "xxx", state: "IN_PROGRESS" }]);

// 完成任务
update_tasks([{ task_id: "xxx", state: "COMPLETE" }]);
```

**重要**：完成一个任务后**立即**标记 COMPLETE，不要批量更新。

## 项目初始化

AI 进入新项目时，应该：

1. [ ] 阅读 `AGENTS.md` 了解项目结构和规范
2. [ ] 阅读 `docs/plans/` 了解进行中的工作
3. [ ] 运行检查命令验证环境可用
4. [ ] 了解测试命令和覆盖率要求
5. [ ] 确认 Git 分支和提交规范

## 核心原则总结

| 原则 | 说明 |
|------|------|
| **Plan 先行** | 先讨论清楚再动手，避免返工 |
| **协作讨论** | 双向沟通，不是单方面指挥 |
| **测试保障** | 分层测试，渐进验证 |
| **渐进交付** | Stage by Stage，确认后继续 |
| **清晰沟通** | 表格总结，明确下一步 |
| **主动暴露** | 问题和困难及时说明 |

遵循这套方法，AI 和人类可以高效协作完成复杂项目。

